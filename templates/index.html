<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å­—å¹•è™•ç†</title>
<style>
  .notice {
    display: flex;
    align-items: center;
    background: #fff4f4;
    border: 1px solid #e5a3a3;
    border-radius: 8px;
    color: #a32b2b;
    padding: 10px 14px;
    margin-top: 12px;
    font-size: 15px;
  }

  .notice button {
    margin-left: 10px;
    background: #fff;
    border: 1px solid #a32b2b;
    border-radius: 6px;
    color: #a32b2b;
    font-weight: 600;
    padding: 6px 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .notice button:hover {
    background: #a32b2b;
    color: #fff;
  }
body { font-family: system-ui, -apple-system, Segoe UI, Noto Sans TC, Arial; margin: 24px; }
label { display:block; margin-top: 12px; }
input[type=text], input[type=url], input[type=password], select { width: 520px; max-width: 100%; padding: 8px; }
button { padding: 8px 16px; margin-top: 16px; }
pre { background: #111; color: #0f0; padding: 12px; white-space: pre-wrap; }
.ok { color: #0a0; }
.err { color: #a00; }
a.filelink { display: inline-block; margin-right: 10px; }
</style>
</head>
<body>
<h1>å­—å¹•è™•ç†</h1>

<form id="f">
  <label>è‹±æ–‡æª”æ¡ˆåç¨±
    <input type="text" name="file_name_en" placeholder="ä¾‹å¦‚ï¼šå†è¦‹æŸæ—ï¼¿è‹±æ–‡">
  </label>
  <label>è‹±æ–‡é›²ç«¯ç¡¬ç¢Ÿé€£çµ
    <input type="url" name="drive_url_en" placeholder="https://drive.google.com/...">
  </label>

  <label>ä¸­æ–‡å­—å¹•æª”æ¡ˆåç¨±
    <input type="text" name="file_name_ch" placeholder="ä¾‹å¦‚ï¼šå†è¦‹æŸæ—ï¼¿ä¸­æ–‡">
  </label>
  <label>ä¸­æ–‡å­—å¹•é›²ç«¯ç¡¬ç¢Ÿé€£çµ
    <input type="url" name="drive_url_ch" placeholder="https://drive.google.com/...">
  </label>

  <label>OCR å¼•æ“
    <select name="ocr">
      <option value="paddle" selected>OCR Paddle</option>
      <option value="gemini">OCR Geminiâ¬è«‹æ–°å¢api key</option>
    </select>
  </label>

  <label>API Key
    <input type="password" name="api_key" placeholder="è¼¸å…¥ API é‡‘é‘°">
  </label>

  <label>ç¿»è­¯é¸é …
    <select name="translate">
      <option value="">ï¼ˆå¯ç•™ç©ºï¼‰</option>
      <option value="none">ä¸ç¿»è­¯</option>
      <option value="en2zh">è‹±â†’ä¸­</option>
      <option value="zh2en">ä¸­â†’è‹±</option>
    </select>
  </label>

  <button type="submit">é–‹å§‹è™•ç†</button>
  <div style="display:flex; align-items:center; color: rgb(169, 43, 43);">
    <button type="button" id="resetBtn" style="margin-right:4px;">RESET</button>
    ğŸ—£ï¸æé†’ï¼šç¢ºèªæª”æ¡ˆä¸‹è¼‰å¾Œè«‹æŒ‰ä¸‹ã€Œresetã€ï¼Œæ¸…é™¤åŸ·è¡Œè³‡æ–™ï¼Œæ‰èƒ½é‹è¡Œä¸‹ä¸€ä»½æª”æ¡ˆ
  </div>
  <div style="display:flex; align-items:center; color: rgb(169, 43, 43);">
    <button type="button" id="shutdownBtn" style="margin-right:4px;">é—œé–‰ç¨‹å¼</button>
    ğŸ—£ï¸æé†’ï¼šçµæŸä½¿ç”¨å‰è«‹ã€Œå‹™å¿…ã€æŒ‰ä¸‹ã€Œé—œé–‰ç¨‹å¼ã€ğŸŒ¹ğŸ¥Ÿ
  </div>
  
</form>

<h2>åŸ·è¡Œçµæœ</h2>
<div id="result"></div>

<script>
const f = document.getElementById('f');
const result = document.getElementById('result');

f.addEventListener('submit', async (e) => {
  e.preventDefault();
  result.innerHTML = 'åŸ·è¡Œä¸­â€¦';
  const payload = Object.fromEntries(new FormData(f).entries());

  try {
    const res = await fetch('/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    let html = '';
    for (const [name, code, out] of (data.logs || [])) {
      html += `<h3>${name} ${code===0?'<span class="ok">âœ”</span>':'<span class="err">âœ–</span>'}</h3>`;
      html += `<pre>${String(out||'').replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))}</pre>`;
    }

    if (data.files) {
      html += `<h3>è¼¸å‡ºæª”æ¡ˆ</h3>`;
      if (data.files.en)    html += `<a class="filelink" href="${data.files.en}" download>è‹±æ–‡å­—å¹•ï¼ˆ.srtï¼‰</a>`;
      if (data.files.zh)    html += `<a class="filelink" href="${data.files.zh}" download>ä¸­æ–‡å­—å¹•ï¼ˆ.srtï¼‰</a>`;
      if (data.files.merge) html += `<a class="filelink" href="${data.files.merge}" download>ä¸­æ–‡å­—å¹•ï¼ˆå°é½Šå¾Œï¼‰ï¼ˆmerged.srtï¼‰</a>`;
    }

    result.innerHTML = html;
  } catch (err) {
    result.innerHTML = `<pre class="err">åŸ·è¡ŒéŒ¯èª¤ï¼š${err}</pre>`;
  }
});

const resetBtn = document.getElementById('resetBtn');
resetBtn.addEventListener('click', async () => {
  const ok = window.confirm('ç¢ºèªè¦æ¸…ç©º data/* èˆ‡ output/*ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹å…ˆå„²å­˜ç›¸é—œæª”æ¡ˆã€‚');
  if (!ok) return;

  resetBtn.disabled = true;
  const prev = result.innerHTML;
  result.innerHTML = 'æ¸…ç†ä¸­â€¦';

  try {
    const res = await fetch('/reset', { method: 'POST' });
    const data = await res.json();
    if (data.ok) {
      const msg =
        `å·²æ¸…ç©ºã€‚\n` +
        `dataï¼šåˆªé™¤ ${data.data.files} æª”ã€${data.data.dirs} è³‡æ–™å¤¾\n` +
        `outputï¼šåˆªé™¤ ${data.output.files} æª”ã€${data.output.dirs} è³‡æ–™å¤¾`;
      result.innerHTML = `<pre>${msg}</pre>`;
    } else {
      result.innerHTML = `<pre class="err">é‡ç½®å¤±æ•—</pre>`;
    }
  } catch (e) {
    result.innerHTML = `<pre class="err">é‡ç½®ç™¼ç”ŸéŒ¯èª¤ï¼š${e}</pre>`;
  } finally {
    resetBtn.disabled = false;
  }
});

const shutdownBtn = document.getElementById('shutdownBtn');
shutdownBtn.addEventListener('click', async () => {
  const ok = confirm('ç¢ºå®šè¦é—œé–‰ Flask ä¼ºæœå™¨å—ï¼Ÿ');
  if (!ok) return;
  try {
    const res = await fetch('/shutdown', { method: 'POST' });
    // é€å‡ºå¾Œé€£ç·šæœƒæ–·ï¼Œé€™æ˜¯æ­£å¸¸
  } catch (_) {
    // ignore
  }
});


</script>
</body>
</html>
